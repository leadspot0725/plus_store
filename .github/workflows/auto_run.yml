name: Run Keyword Collector

on:
  workflow_dispatch:  # 수동 실행 가능

permissions:
  id-token: write  # Workload Identity Federation을 위한 권한 설정
  contents: read   # Repository 파일 읽기 권한

jobs:
  build:
    runs-on: ubuntu-latest  # 최신 Ubuntu 환경 사용
    steps:

      # 1️⃣ 저장소 체크아웃 (GitHub Actions에서 코드 가져오기)
      - name: 저장소 체크아웃
        uses: actions/checkout@v4

      # 2️⃣ Python 설정 (버전 3.10 사용)
      - name: Python 3.10 설정
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 3️⃣ Google Cloud 인증 (Workload Identity Federation)
      - name: Google Cloud 인증 (OIDC 사용)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      # 4️⃣ 필수 라이브러리 설치
      - name: 필요한 Python 패키지 설치
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 5️⃣ 최신 Chrome 및 ChromeDriver 설치 (EOF 오류 수정)
      - name: 최신 Chrome & ChromeDriver 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip jq

          # 최신 Chrome 설치
          wget -q -O google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome.deb || sudo apt-get install -f -y

          # Chrome 버전 확인 (EOF 오류 수정)
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
          echo "Chrome Version: $CHROME_VERSION"

          # ChromeDriver 최신 버전 찾기 및 다운로드
          DRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/latest-versions-per-milestone.json" | jq -r '.milestones["'${CHROME_VERSION%%.*}'"].downloads.chromeDriver[] | select(.platform=="linux64").url')
          
          if [[ -z "$DRIVER_URL" ]]; then
            echo "ChromeDriver URL을 찾을 수 없습니다. Chrome 버전: $CHROME_VERSION"
            exit 1
          fi

          wget -q "$DRIVER_URL" -O chromedriver.zip
          unzip chromedriver.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

          # ChromeDriver 버전 확인
          chromedriver --version

      # 6️⃣ 스크립트 실행 (연관 키워드 크롤링)
      - name: Run Python Keyword Collector
        run: python keyword_collector.py
